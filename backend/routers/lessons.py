from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List
import json

from database import get_db
import models

router = APIRouter(prefix="/api/lessons", tags=["lessons"])

@router.get("", response_model=dict)
def get_lessons(db: Session = Depends(get_db)):
    lessons = db.query(models.Lesson).order_by(models.Lesson.order_index).all()
    
    lessons_list = []
    for lesson in lessons:
        item = {
            "id": lesson.id,
            "title": lesson.title,
            "content": lesson.content,
            "order_index": lesson.order_index,
            "difficulty": lesson.difficulty,
            "goal": lesson.goal,
            "hints": json.loads(lesson.hints) if lesson.hints else [],
            "validation_rules": json.loads(lesson.validation_rules) if lesson.validation_rules else {},
            "example_role": lesson.example_role,
            "example_context": lesson.example_context,
            "example_action": lesson.example_action
        }
        lessons_list.append(item)
        
    return {"success": True, "lessons": lessons_list}

@router.get("/{id}")
def get_lesson(id: int, db: Session = Depends(get_db)):
    lesson = db.query(models.Lesson).filter(models.Lesson.id == id).first()
    if not lesson:
        raise HTTPException(status_code=404, detail="Lesson not found")

    item = {
        "id": lesson.id,
        "title": lesson.title,
        "content": lesson.content,
        "order_index": lesson.order_index,
        "difficulty": lesson.difficulty,
        "goal": lesson.goal,
        "hints": json.loads(lesson.hints) if lesson.hints else [],
        "validation_rules": json.loads(lesson.validation_rules) if lesson.validation_rules else {},
        "example_role": lesson.example_role,
        "example_context": lesson.example_context,
        "example_action": lesson.example_action
    }
    return {"success": True, "lesson": item}

@router.post("/{id}/validate")
def validate_lesson(id: int, payload: dict, db: Session = Depends(get_db)):
    tokenCount = payload.get("tokenCount", 0)
    command = payload.get("command", {})

    lesson = db.query(models.Lesson).filter(models.Lesson.id == id).first()
    if not lesson:
        raise HTTPException(status_code=404, detail="Lesson not found")

    rules = json.loads(lesson.validation_rules) if lesson.validation_rules else {}
    passed = True
    feedback = ''

    if rules.get("maxTokens") and tokenCount > rules["maxTokens"]:
        passed = False
        feedback = f'í† í° ìˆ˜ê°€ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ({tokenCount}/{rules["maxTokens"]}) ë” ê°„ê²°í•˜ê²Œ ì‘ì„±í•´ë³´ì„¸ìš”.'

    if rules.get("requiredDevice") and command.get("device") != rules["requiredDevice"]:
        passed = False
        feedback = f'ì¥ì¹˜ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. "{rules["requiredDevice"]}"ë¥¼ ì œì–´í•´ì•¼ í•©ë‹ˆë‹¤.'

    if rules.get("requiredDevices") and command.get("device") not in rules["requiredDevices"]:
        passed = False
        feedback = f'ì¥ì¹˜ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. {" ë˜ëŠ” ".join(rules["requiredDevices"])}ë¥¼ ì œì–´í•´ì•¼ í•©ë‹ˆë‹¤.'

    if rules.get("requiresCommand") and (not command or command.get("device") == "none"):
        passed = False
        feedback = 'ìœ íš¨í•œ ì œì–´ ëª…ë ¹ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.'

    if passed:
        feedback = 'ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ë ˆìŠ¨ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!'

    return {"success": True, "passed": passed, "feedback": feedback}
